{% extends 'base.html' %}

{% block title %}Realtime{% endblock %}

{% block head %}
  <!-- MAPS JS -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='vendor/map/style.css')}}" />
  <script src="{{url_for('static', filename='vendor/map/js.js')}}"></script>
    <!-- search -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>   
  <style>
    #mapid {
      border: 1px solid rgb(185, 184, 184);
    }
    #mapform {
      margin-top: 5% !important;
    }
  </style>
{% endblock %}

{% block body %}	
<div class="">
  <div id="mapid" style="width: 100%;">  
    <div class="leaflet-top leaflet-right" id="mapform">
      <div class="leaflet leaflet-control">
        <div class="container">
          <div class="text-center">
            <strong>Realtime</strong>
            <br>
            <small>Monitoring</small>
          </div>
          <hr>
          <div class="text-center">
            <div>
              <button class="btn btn-sm btn-success fas fa-paper-plane"></button>
            </div>
            <br>
            <div>
              <button class="btn btn-sm btn-primary fas fa-pen"></button>
            </div>
            <br>
            <div>
              <button class="btn btn-sm btn-danger fas fa-warning"></button>
            </div>
          </div>
          <hr>
          <div class="text-center">
            <strong id="time"></strong>
          </div>
          <br>
          <div class="text-center">
            <!-- <h5 class="fas fa-spinner fa-pulse text-success"></h5> -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  $(document).ready(function(){

    document.getElementById("mapid").style.height = screen.height+"px"; 

    var mymap = undefined;

    var longit, latit;

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(setPosition);
      } else { 
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
        
    function setPosition(position) {
        longit = position.coords.latitude;
        latit = position.coords.longitude;
        
        if(longit != undefined && latit != undefined) {
          if (mymap == undefined)
            displayMap();
        }
    }

    getLocation();

    function displayMap() {
      
      // var mymap = L.map('mapid').setView([51.505, -0.09], 13);
      if (mymap == undefined)
      {
        mymap = L.map('mapid').setView([longit, latit], 10);
      }

      L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
          'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1
      }).addTo(mymap);

      // L.marker([8.170712, 125.109558]).addTo(mymap)
      L.marker([longit, latit]).addTo(mymap)
        .bindPopup("<b>Hi Gay!</b><br />This is your location.").openPopup();

      // Setting up markers of transmitters

      var trans = JSON.parse('{{transmitters | tojson | safe}}');

      trans.forEach(element => {
        L.marker([element.longitude, element.latitude]).addTo(mymap)
          .bindPopup("<b>"+element.name+"</b><br />"+element.location+"<br /><small><i class='fas fa-directions'></i> "+element.post_description+"</small>");
      });

      // end setting up markers of transmitters

      L.circle([51.508, -0.11], 500, {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5
      }).addTo(mymap).bindPopup("I am a circle.");

      L.polygon([
        [51.509, -0.08],
        [51.503, -0.06],
        [51.51, -0.047]
      ]).addTo(mymap).bindPopup("I am a polygon.");


      var popup = L.popup();

      function onMapClick(e) {
        popup
          .setLatLng(e.latlng)
          .setContent("You clicked the map at " + e.latlng.toString())
          .openOn(mymap);
      }
      
      // search
      L.Control.geocoder().addTo(mymap);

      mymap.on('click', onMapClick);
    }


    // tick time
    function ticktime() {
        var d = new Date(Date.now());
        var target = document.getElementById("time");
        $("#time").text(d.toLocaleTimeString());
    }
    setInterval(ticktime, 1000);
    // end tick time

  })

</script>
{% endblock %}