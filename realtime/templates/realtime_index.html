{% extends 'base.html' %}

{% block title %}Realtime{% endblock %}

{% block head %}
<!-- MAPS JS -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='vendor/map/style.css')}}" />
<!-- <script src="{{url_for('static', filename='vendor/map/js.js')}}"></script> -->

<!-- search -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>   
<!-- end map js -->

  <style>
    #mapid {
      border: 1px solid rgb(185, 184, 184);
    }
    #mapform {
      margin-top: 5% !important;
    }
    #leftControl {
      margin-top: 10% !important;
      margin-left: -1.6% !important;
    }
    .text-yellow {
      color: yellow;
    }
    .legend {
      font-size: 1.5rem;
    }
    .hide {
      display: none;
    }
    .show {
      display: inherit;
    }
  </style>
{% endblock %}

{% block body %}	
<div class="">
  <div id="mapid" style="width: 100%;">  
    <div style="margin: auto;">
      <h5 class="text-muted text-center" style="margin: auto; width: 30%;">No internet connection</h5>
    </div>
    <!-- left panel control -->
    <div class="leaflet-top leaflet-left hide" id="leftControl">
      <div class="leaflet leaflet-control">
        <div class="container">
          <div class="text-center">
            <a href="#">
              <h5 id="status" class="" style="font-size: 2.5rem;" data-toggle="tooltip" data-placement="right" title="Receiver module connection status"></h5></a>
          </div>
        </div>
      </div>
    </div>
    <!-- end left panel control -->
    <!-- right panel control -->
    <div class="leaflet-top leaflet-right hide" id="mapform">
      <div class="leaflet leaflet-control">
        <div class="container">
          <div class="text-center">
            <strong>Realtime</strong>
            <br>
            <small>Monitoring</small>
          </div>
          <hr>
          <div class="text-center">
            <div>
              <i class="text-primary fas fa-map-marker-alt legend" data-toggle="tooltip" data-placement="left" title="Normal water level"></i>
            </div>
            <br>
            <div>
              <i class="text-yellow fas fa-map-marker-alt legend" data-toggle="tooltip" data-placement="left" title="Above normal water level"></i>
            </div>
            <br>
            <div>
              <i class="text-warning fas fa-map-marker-alt legend" data-toggle="tooltip" data-placement="left" title="Warning alert"></i>
            </div>
            <br>
            <div>
              <i class="text-danger fas fa-map-marker-alt legend" data-toggle="tooltip" data-placement="left" title="Danger. Residents need to be evacuated"></i>
            </div>
            <br>
            <div>
              <i class="text-center">Legends</i>
            </div>
          </div>
          <hr>
          <div class="text-center">
            <strong id="time"></strong>
          </div>
          <br>
          <div class="text-center">
            <!-- <h5 class="fas fa-spinner fa-pulse text-success"></h5> -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  $(document).ready(function(){

    document.getElementById("mapid").style.height = screen.height+"px"; 

    var mymap = undefined;

    var markers = [];

    var longit, latit;

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(setPosition);
      } else { 
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
        
    function setPosition(position) {
        longit = position.coords.latitude;
        latit = position.coords.longitude;

        if(longit != undefined && latit != undefined) {
          if (mymap == undefined)
            displayMap();
        }
    }

    getLocation();

    function displayMap() {
      
      // var mymap = L.map('mapid').setView([51.505, -0.09], 13);
      if (mymap == undefined)
      {
        mymap = L.map('mapid').setView([longit, latit], 10);
      }

      L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
          'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1
      }).addTo(mymap);

      // L.marker([8.170712, 125.109558]).addTo(mymap)
      L.marker([longit, latit]).addTo(mymap)
        .bindPopup("<b>Hi Gay!</b><br />This is your location.").openPopup();

      // define transmitter marker icon
      var trasnIcon = L.icon({
          iconUrl: "{{ url_for('static', filename='vendor/leaflet/images/marker.png') }}",
          // shadowUrl: "{{ url_for('static', filename='vendor/leaflet/images/marker-shadow.png') }}",

          iconSize:     [55, 55], // size of the icon
          shadowSize:   [50, 64], // size of the shadow
          iconAnchor:   [12, 54], // point of the icon which will correspond to marker's location
          shadowAnchor: [4, 62],  // the same for the shadow
          popupAnchor:  [-2, -46] // point from which the popup should open relative to the iconAnchor
      });

      // Setting up markers of transmitters
      var trans = JSON.parse('{{transmitters | tojson | safe}}');

      trans.forEach(element => {
        var id = element.name.replace(' ', '');

        var mrker = L.marker([element.longitude, element.latitude], {id:id});

        
        mrker.bindPopup("<div><b>"+element.name+"</b><br />"+element.location+"<br /><small><i class='fas fa-directions'></i> "+element.post_description+"</small></div>");
        mrker.addTo(mymap);

        markers.push(mrker);

          // L.marker([element.longitude, element.latitude], {icon:trasnIcon}).addTo(mymap)
          // .bindPopup("<div><b>"+element.name+"</b><br />"+element.location+"<br /><small><i class='fas fa-directions'></i> "+element.post_description+"</small></div>");
      });

      // end setting up markers of transmitters

      L.circle([51.508, -0.11], 500, {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5
      }).addTo(mymap).bindPopup("I am a circle.");

      L.polygon([
        [51.509, -0.08],
        [51.503, -0.06],
        [51.51, -0.047]
      ]).addTo(mymap).bindPopup("I am a polygon.");


      var popup = L.popup();

      function onMapClick(e) {
        popup
          .setLatLng(e.latlng)
          .setContent("You clicked the map at " + e.latlng.toString())
          .openOn(mymap);
      }
      
      // search
      L.Control.geocoder().addTo(mymap);
      // query latest alert updaet

    // markers
    var LeafIcon = L.Icon.extend({
        options: {
            // shadowUrl: "{{ url_for('static', filename='vendor/leaflet/images/marker-shadow.png') }}",
            iconSize:     [55, 55],
            shadowSize:   [55, 64],
            iconAnchor:   [27, 56],
            shadowAnchor: [4, 62],
            popupAnchor:  [1, -50]
        }
    });

    var normalIcon = new LeafIcon({iconUrl: "{{ url_for('static', filename='vendor/leaflet/images/marker-normal.png') }}"});
    var yellowIcon = new LeafIcon({iconUrl: "{{ url_for('static', filename='vendor/leaflet/images/marker-yellow.png') }}"});
    var orangeIcon = new LeafIcon({iconUrl: "{{ url_for('static', filename='vendor/leaflet/images/marker-orange.png') }}"});
    var redIcon = new LeafIcon({iconUrl: "{{ url_for('static', filename='vendor/leaflet/images/marker-red.png') }}"});

    function query() {
      $.ajax({
        url:'/realtime/query',
        method:'GET',
        data:{},
        success:function(sms) {
          var trans = sms.transmitter;

          var id = trans.name.replace(' ', '');

          markers.forEach(element => {
            if (element.options.id == id) {

              switch(parseInt(sms.alert_level)) 
              {
                case 1:
                  element.setIcon(normalIcon);
                  element.bindPopup("<div><strong class='fas fa-warning text-primary'> Normal level</strong><br><b>"+trans.name+"</b><br />"+trans.location+"<br /><small><i class='fas fa-directions'></i> "+trans.post_description+"</small></div>");
                  break;
                case 2:
                  element.setIcon(yellowIcon);
                  element.bindPopup("<div><strong class='fas fa-warning text-yellow'> Yellow warning</strong><br><b>"+trans.name+"</b><br />"+trans.location+"<br /><small><i class='fas fa-directions'></i> "+trans.post_description+"</small></div>");
                  break;
                case 3:
                  element.setIcon(orangeIcon);
                  element.bindPopup("<div><strong class='fas fa-warning text-warning'> Orange warning</strong><br><b>"+trans.name+"</b><br />"+trans.location+"<br /><small><i class='fas fa-directions'></i> "+trans.post_description+"</small></div>");
                  break;
                case 4:
                  element.setIcon(redIcon);
                  element.bindPopup("<div><strong class='fas fa-warning text-danger'> Danger</strong><br><b>"+trans.name+"</b><br />"+trans.location+"<br /><small><i class='fas fa-directions'></i> "+trans.post_description+"</small></div>");
                  break;
              }

              element.openPopup();

            }
          });
        }
      })
    }

    query();

    setInterval(query, 5000);


    // end query latest alert update

      mymap.on('click', onMapClick);

      $("#leftControl").removeClass("hidden");
      $("#leftControl").addClass("show");
      $("#mapform").removeClass("hidden");
      $("#mapform").addClass("show");
    }


    // tick time
    function ticktime() {
        var d = new Date(Date.now());
        var target = document.getElementById("time");
        $("#time").text(d.toLocaleTimeString());
    }
    setInterval(ticktime, 1000);
    // end tick time



    // detect arduino
    
    function detectArduino() {
      $.ajax({
            url:'/arduino/render',
            type:'post',
            data:{},
            success:function(data) {
                if(data.connected) {
                    $("#status").removeClass("text-danger");
                    $("#status").removeClass("fas fa-warning");
                    $("#status").addClass("text-success");
                    $("#status").addClass("fas fa-spinner fa-pulse");
                    // $("#status").text(" Connected!");
                }
                else {
                    $("#status").removeClass("text-success");
                    $("#status").removeClass("fas fa-spinner fa-pulse");
                    $("#status").addClass("text-danger");
                    $("#status").addClass("fas fa-warning");
                    // $("#status").text(" Disconnected!");
                }
                // $("#r_status").removeClass("fas fa-spinner fa-spin text-light");
            }
        })
    }
    detectArduino();
    // end detect arduino

    $("#realtime").addClass('active');

  })

</script>
{% endblock %}